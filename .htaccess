# ============================================
# CẤU HÌNH .HTACCESS CHO CINEMA BOOKING SYSTEM
# ============================================
# File: .htaccess
# Mô tả: Cấu hình đầy đủ cho hosting
# Ngày tạo: 2025-01-20
# ============================================

# ============================================
# 1. ENABLE REWRITE ENGINE
# ============================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
</IfModule>

# ============================================
# 2. DEFAULT INDEX FILES
# ============================================
DirectoryIndex views/clinet/index.php index.php index.html index.htm

# ============================================
# 3. SECURITY SETTINGS
# ============================================

# Tắt directory listing
Options -Indexes +FollowSymLinks

# Ẩn thông tin server và PHP version
<IfModule mod_headers.c>
    Header unset Server
    Header unset X-Powered-By
</IfModule>
ServerSignature Off

# Chặn truy cập trực tiếp vào các file nhạy cảm
<FilesMatch "\.(sql|env|log|ini|conf|config|bak|backup|old|tmp)$">
    Require all denied
</FilesMatch>

# Bảo vệ file .htaccess và .htpasswd
<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

# Chặn truy cập vào file database config trong thư mục function/
<Files "function/db.php">
    Require all denied
</Files>

# ============================================
# 4. URL ROUTING & REWRITING
# ============================================

<IfModule mod_rewrite.c>
    # Chặn truy cập trực tiếp vào các thư mục function/ và handle/
    RewriteCond %{REQUEST_URI} ^/(function|handle)/ [NC]
    RewriteRule ^ - [F,L]
    
    # Cho phép truy cập trực tiếp vào các file tĩnh (CSS, JS, images)
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteCond %{REQUEST_FILENAME} \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|pdf|zip)$ [NC]
    RewriteRule ^ - [L]
    
    # Chặn truy cập trực tiếp vào file .sql
    RewriteCond %{REQUEST_URI} \.(sql)$ [NC]
    RewriteRule ^ - [F,L]
    
    # Redirect root tới trang chủ client
    RewriteRule ^$ views/clinet/index.php [L]
    RewriteRule ^index.php$ views/clinet/index.php [L]
    
    # Routing cho admin panel
    RewriteRule ^admin/?$ views/admin/index.php [L]
    RewriteRule ^admin/(.*)$ views/admin/$1 [L]
    RewriteRule ^admin/(.*)$ admin/$1 [L]
    RewriteRule ^admin/(.*)$ /$1 [L]
    
    # Routing cho client views
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ views/clinet/$1 [L,QSA]
</IfModule>

# ============================================
# 5. PHP CONFIGURATION
# ============================================

<IfModule mod_php.c>
    # Ẩn lỗi trong production (bật display_errors = Off)
    php_flag display_errors Off
    php_flag display_startup_errors Off
    php_value error_reporting E_ALL
    php_flag log_errors On
    
    # Giới hạn kích thước upload (50MB)
    php_value upload_max_filesize 50M
    php_value post_max_size 50M
    php_value max_execution_time 300
    php_value max_input_time 300
    # Memory limit
    php_value memory_limit 256M
    
    # Timezone (Asia/Ho_Chi_Minh cho Việt Nam)
    php_value date.timezone "Asia/Ho_Chi_Minh"
    
    # Session settings
    php_value session.gc_maxlifetime 3600
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 0
    php_flag session.use_only_cookies On
</IfModule>

# ============================================
# 6. PERFORMANCE OPTIMIZATION
# ============================================

# Enable Gzip Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml application/rss+xml application/atom+xml image/svg+xml
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS và JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML
    ExpiresByType text/html "access plus 0 seconds"
    
    # Default
    ExpiresDefault "access plus 2 days"
</IfModule>

# Cache-Control Headers
<IfModule mod_headers.c>
    # CSS và JavaScript
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
    
    # Images
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|svg|webp)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>
    
    # Fonts
    <FilesMatch "\.(woff|woff2|ttf|eot)$">
        Header set Cache-Control "max-age=31536000, public"
    </FilesMatch>
</IfModule>

# ============================================
# 7. SECURITY HEADERS
# ============================================

<IfModule mod_headers.c>
    # XSS Protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Prevent MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Prevent clickjacking
    Header set X-Frame-Options "SAMEORIGIN"
    
    # Referrer Policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (CSP) - Có thể tùy chỉnh thêm